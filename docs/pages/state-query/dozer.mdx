import { Callout } from "nextra/components";

# Dozer

If there is a dozer instance serving a blockchain, as there is for [Redstone](https://redstone.xyz/) and [Garnet](https://garnetchain.com/docs/what-is-redstone), you can use it to run queries on the data of any `World` on that blockchain.

The query language is a subset of [the SQL `SELECT` command](<https://en.wikipedia.org/wiki/Select_(SQL)>).

## Example `World`

On Garnet there is a `World` at address [`0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e`](https://explorer.garnetchain.com/address/0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e) that runs a slightly modified version of [the React template](https://github.com/latticexyz/mud/tree/main/templates/react).
You can see the data schema for the `World` [in the block explorer](https://explorer.garnetchain.com/address/0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e?tab=mud).

<details>

<summary>How to change the `World` data</summary>

1. Create and run a react template application.

   ```sh copy
   pnpm create mud@latest tasks --template react
   cd tasks
   pnpm dev
   ```

1. [Browse to the application](http://localhost:3000/?chainId=17069&worldAddress=0x95f5d049b014114e2feeb5d8d994358ce4ffd06e).
   The URL specifies the `chainId` and `worldAddress` for the `World`.

1. In Mud DevTools see your account address and [fund it on Garnet](https://garnetchain.com/faucet).
   You may need to get test ETH for your own address, and then transfer it to the account address the application uses.

</details>

The Garnet dozer instance is at `https://dozer.mud.garnetchain.com`.

## cUrl

### Simple query

This query looks for some fields from a single table.

1. Create a file, `query.json`, with this content.

   ```json filename="query.json" copy
   [
     {
       "address": "0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e",
       "query": "SELECT id, description FROM app__Tasks"
     }
   ]
   ```

   <Callout type="info" emoji="ℹ️">

   Dozer does not support `SELECT * FROM <table>`, you have to specify column names.

   </Callout>

1. Run this command. Install `curl` and `jq` first if necessary.

   ```sh copy
   curl https://dozer.mud.garnetchain.com/q --compressed  -H 'Accept-Encoding: gzip'  -H 'Content-Type: application/json' -d @query.json | jq
   ```

The output is a mapping with two fields, the block height for which the result is valid, and the result itself.
The result is a list of query responses, here it contains just one item because we only submitted a single query.
The query response is also a list.
The first entry is the field names, and all the other entries are rows returned by `SELECT`.

```
{
  "block_height": 5699682,
  "result": [
    [
      [
        "id",
        "description"
      ],
      [
        "0x3100000000000000000000000000000000000000000000000000000000000000",
        "Walk the dog"
      ],
      [
        "0x3e0a112aadc5e02927fb4a91649bea565fd1baa1175aae4cb4957d6348f165cf",
        "Test"
      ],
    ]
  ]
}
```

Here we only care about the first result, so from now on we use this command line to tell `jq` to only show us that information.

```sh copy
curl https://dozer.mud.garnetchain.com/q --compressed  -H 'Accept-Encoding: gzip'  -H 'Content-Type: application/json' -d @query.json | jq '.result[0]'
```

### Conditions

If we want to see only those tasks that haven't been completed we can use a `WHERE` clause.

```json filename="query.json" copy
[
  {
    "address": "0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e",
    "query": "SELECT id, description FROM app__Tasks WHERE completedAt=0"
  }
]
```

<details>

<summary>Results</summary>

```json
[
  ["id", "description"],
  ["0x3100000000000000000000000000000000000000000000000000000000000000", "Walk the dog"],
  ["0x3e0a112aadc5e02927fb4a91649bea565fd1baa1175aae4cb4957d6348f165cf", "Test"]
]
```

</details>

### Limited results

If you only want to see a few results, you can use a `LIMIT` clause.

```json filename="query.json" copy
[
  {
    "address": "0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e",
    "query": "SELECT id, description FROM app__Tasks LIMIT 2"
  }
]
```

<details>

<summary>Results</summary>

```json
[
  ["id", "description"],
  ["0x3100000000000000000000000000000000000000000000000000000000000000", "Walk the dog"],
  ["0x3e0a112aadc5e02927fb4a91649bea565fd1baa1175aae4cb4957d6348f165cf", "Test"]
]
```

</details>

You can use `OFFSET` to get a paging effect.
For example, if you use this `query.json` you get two results, and the last row of the first one is repeated as the first row of the second one.

```json filename="query.json" copy
[
  {
    "address": "0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e",
    "query": "SELECT id, description FROM app__Tasks LIMIT 3"
  },
  {
    "address": "0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e",
    "query": "SELECT id, description FROM app__Tasks LIMIT 3 OFFSET 2"
  }
]
```

<details>

<summary>Results</summary>

Use this command to see the results of both queries.

```sh copy
curl https://dozer.mud.garnetchain.com/q --compressed  \
  -H 'Accept-Encoding: gzip' \
  -H 'Content-Type: application/json' -d @query.json \
  | jq '.result'
```

The result is:

```json
[
  [
    ["id", "description"],
    ["0x3100000000000000000000000000000000000000000000000000000000000000", "Walk the dog"],
    ["0x3e0a112aadc5e02927fb4a91649bea565fd1baa1175aae4cb4957d6348f165cf", "Test"],
    ["0xb15fd0e41ab0bb6eb992e0a3d4f30fce6ee24a5fc9c30f725fdfc96d9d16ed95", "Do the dishes"]
  ],
  [
    ["id", "description"],
    ["0xb15fd0e41ab0bb6eb992e0a3d4f30fce6ee24a5fc9c30f725fdfc96d9d16ed95", "Do the dishes"],
    ["0xb81d5036d0b62e0f2536635cbd5d7cec1d1f0706c0c6c1a9fa74293d7b0888eb", "Take out the trash"]
  ]
]
```

</details>

### Multiple tables

You can join multiple tables, using the same syntax SQL uses.

```json filename="query.json" copy
[
  {
    "address": "0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e",
    "query": "SELECT app__Creator.id, description, taskCreator FROM app__Tasks, app__Creator WHERE app__Creator.id=app__Tasks.id"
  }
]
```

<details>

<summary>Results</summary>

```json
[
  ["id", "description", "taskcreator"],
  [
    "0x3e0a112aadc5e02927fb4a91649bea565fd1baa1175aae4cb4957d6348f165cf",
    "Test",
    "0x735b2f2c662ebedffa94027a7196f0559f7f18a4"
  ],
  [
    "0x727d7bfe00b6db638c69595059dc10e21c52a7912d090905a7c7dc8659efd3b8",
    "Test from a different account",
    "0x428b1853e5ec29d35c84a218ec5170efc7621b58"
  ],
  [
    "0xb15fd0e41ab0bb6eb992e0a3d4f30fce6ee24a5fc9c30f725fdfc96d9d16ed95",
    "Do the dishes",
    "0x8225d72f2c39f3729d7f3fc03c6aa8731eaeef48"
  ],
  [
    "0xb81d5036d0b62e0f2536635cbd5d7cec1d1f0706c0c6c1a9fa74293d7b0888eb",
    "Take out the trash",
    "0x8225d72f2c39f3729d7f3fc03c6aa8731eaeef48"
  ],
  [
    "0xd43394ecf79077f65cd83b534dd44d3b4e9e2aa553e95aafecd14b8529543cda",
    "Another test",
    "0x428b1853e5ec29d35c84a218ec5170efc7621b58"
  ]
]
```

</details>

### Grouping results

You can use `GROUP BY` to identify different groups.
For example, this query gets you the different task creators.

```json filename="query.json" copy
[
  {
    "address": "0x95F5d049B014114E2fEeB5d8d994358Ce4FFd06e",
    "query": "SELECT taskCreator FROM app__Creator GROUP BY taskCreator"
  }
]
```

<details>

<summary>Results</summary>

```json
[
  ["taskcreator"],
  ["0x428b1853e5ec29d35c84a218ec5170efc7621b58"],
  ["0x735b2f2c662ebedffa94027a7196f0559f7f18a4"],
  ["0x8225d72f2c39f3729d7f3fc03c6aa8731eaeef48"]
]
```

</details>

## Using dozer from JavaScript
